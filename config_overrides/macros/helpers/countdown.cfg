[gcode_macro COUNTDOWN]
variable_current: 0
variable_cancel: False
variable_alarm: False
gcode:
  {% set duration = params.DURATION | default(60) | int %}
  {% set cancel = params.CANCEL | default(false) | lower == 'true' %}
  {% set alarm = params.ALARM | default(false) | lower == 'true' %}

  SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=alarm VALUE={alarm}

  {% if cancel %}
    UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION=0
  {% else %}
    SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=current VALUE={duration - 1}
    UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION=1
  {% endif %}

[gcode_macro COUNTDOWN_CANCEL]
gcode:
  COUNTDOWN CANCEL=true

[delayed_gcode _COUNTDOWN_LOOP]
initial_duration: 0
gcode:
  {% set vars = printer["gcode_macro COUNTDOWN"] %}
  {% set current = vars.current %}
  {% set alarm = vars.alarm | lower == 'true' %}

  SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=current VALUE={current - 1}

  {% if current > 0 %}
    M117 Remaining: {current}
    {action_respond_info("Countdown: %i remaining" % (current))}
    UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION=1
  {% else %}
    M117 Countdown complete
    {action_respond_info("Countdown complete")}
    UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION=0

    {% if alarm %}
      M300 P250
      M300 P250
      M300 P250
    {% endif %}
  {% endif %}